# webpack å·¥ä½œæµç¨‹

> webpack çš„æ ¸å¿ƒä»»åŠ¡å°±æ˜¯ï¼šå†…å®¹è½¬åŒ–(å®ç°ä¸€äº›æ–°ç‰¹æ€§èƒ½å¤Ÿå…¼å®¹å¤§éƒ¨åˆ†æµè§ˆå™¨ç­‰) å’Œ èµ„æºåˆå¹¶ï¼›

## 1. å·¥ä½œæµç¨‹

### 1.1 åˆå§‹åŒ–é˜¶æ®µ

- **åˆå§‹åŒ–å‚æ•°ï¼š ä»é…ç½®æ–‡ä»¶ã€é…ç½®å¯¹è±¡ã€shell å‚æ•°(æ‰§è¡Œçš„å‘½ä»¤è¡Œå‚æ•°) ä¸­è¯»å–å‚æ•°å¹¶ä¸é»˜è®¤å‚æ•°è¿›è¡Œåˆå¹¶ï¼Œç»„åˆæˆæœ€ç»ˆçš„å‚æ•°ï¼›**
- **åˆ›å»ºç¼–è¯‘å¯¹è±¡ï¼šä½¿ç”¨åˆå§‹åŒ–çš„å‚æ•°åˆ›å»º Compiler å¯¹è±¡ï¼›**
- **åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒï¼šåŒ…æ‹¬æ³¨å…¥å†…ç½®æ’ä»¶ã€æ³¨å†Œå„ç§æ¨¡å—å·¥å‚ï¼Œåˆå§‹åŒ– RuleSet é›†åˆã€åŠ è½½é…ç½®çš„æ’ä»¶ç­‰ï¼›**

### 1.2 æ„å»ºé˜¶æ®µ

- **å¼€å§‹ç¼–è¯‘ï¼šæ‰§è¡Œ Compiler å¯¹è±¡çš„ run æ–¹æ³•ï¼Œåˆ›å»º Compilation å¯¹è±¡ï¼›**
- **ç¡®è®¤ç¼–è¯‘å…¥å£ï¼šè¿›å…¥ entryOption é˜¶æ®µï¼Œè¯»å–é…ç½®çš„ Entriesï¼Œé€’å½’éå†æ‰€æœ‰çš„å…¥å£æ–‡ä»¶ï¼Œè°ƒç”¨ Compilation.addEntry å°†å…¥å£æ–‡ä»¶è½¬æ¢æˆ Dependency å¯¹è±¡ï¼›**
- **ç¼–è¯‘æ¨¡å—(make)ï¼šè°ƒç”¨ normalMoudle ä¸­çš„ build å¼€å¯æ„å»ºï¼Œä» entry æ–‡ä»¶å¼€å§‹ï¼Œè°ƒç”¨ loader å¯¹æ¨¡å—è¿›è¡Œè½¬è¯‘å¤„ç†ï¼Œç„¶åè°ƒç”¨ JS è§£é‡Šå™¨(\*\***[acorn](https://www.npmjs.com/package/acorn)\***\*)å°†å†…å®¹è½¬æ¢æˆ AST å¯¹è±¡ï¼Œç„¶åé€’å½’åˆ†æä¾èµ–ï¼Œä¾æ¬¡å¤„ç†å…¨éƒ¨æ–‡ä»¶ï¼›**
- **å®Œæˆæ¨¡å—ç¼–è¯‘ï¼šåœ¨ä¸Šä¸€æ­¥å¤„ç†å¥½æ‰€æœ‰æ¨¡å—åï¼Œå¾—åˆ°æ¨¡å—ç¼–è¯‘äº§ç‰©å’Œä¾èµ–å…³ç³»å›¾ï¼›**

### 1.3 ç”Ÿæˆé˜¶æ®µ

- **è¾“å‡ºèµ„æº(seal)ï¼šæ ¹æ®å…¥å£å’Œæ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œç»„è£…æˆå¤šä¸ªåŒ…å«å¤šä¸ªæ¨¡å—çš„ Chunkï¼Œå†æŠŠæ¯ä¸ª Chunk è½¬æ¢æˆ Asset åŠ å…¥åˆ°è¾“å‡ºåˆ—è¡¨ï¼Œè¿™æ­¥æ˜¯å¯ä»¥ä¿®æ”¹è¾“å‡ºå†…å®¹çš„æœ€åæœºä¼šï¼›**
- **å†™å…¥æ–‡ä»¶ç³»ç»Ÿ(emitAssets)ï¼šç¡®å®šå¥½è¾“å‡ºå†…å®¹åï¼Œæ ¹æ®é…ç½®çš„ output å°†å†…å®¹å†™å…¥æ–‡ä»¶ç³»ç»Ÿã€‚**

åœ¨ä»¥ä¸Šè¿‡ç¨‹ä¸­ï¼Œwebpack ä¼šåœ¨ç‰¹å®šçš„æ—¶é—´ç‚¹å¹¿æ’­å‡ºç‰¹å®šçš„äº‹ä»¶ï¼Œæ’ä»¶åœ¨ç›‘å¬åˆ°æ„Ÿå…´è¶£çš„äº‹ä»¶åä¼šæ‰§è¡Œç‰¹å®šçš„é€»è¾‘ï¼Œå¹¶ä¸”æ’ä»¶å¯ä»¥è°ƒç”¨ webpack æä¾›çš„ API æ”¹å˜ webpack çš„è¿è¡Œç»“æœ

- webpack.configeration:

> é€šå¸¸ä½ çš„é¡¹ç›®è¿˜éœ€è¦ç»§ç»­æ‰©å±•æ­¤èƒ½åŠ›ï¼Œä¸ºæ­¤ä½ å¯ä»¥åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `webpack.config.js` æ–‡ä»¶ï¼Œç„¶å webpack ä¼šè‡ªåŠ¨ä½¿ç”¨å®ƒã€‚
>
> å¦‚æœå‡ºäºæŸäº›åŸå› ï¼Œéœ€è¦æ ¹æ®ç‰¹å®šæƒ…å†µä½¿ç”¨ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œåˆ™å¯ä»¥é€šè¿‡åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ `--config` æ ‡å¿—ä¿®æ”¹ã€‚

```JSON
"scripts": {"build": "webpack --config prod.config.js"}
```

- Loader
  - Css-loader: è§£æå¼•å…¥çš„ css æ–‡ä»¶
  - Style-loader: å°† css è§£æå‡ºæ¥çš„æ–‡ä»¶æ”¾å…¥ html æ–‡æ¡£ä¸­
  - Postcss-loader: è‡ªåŠ¨æ·»åŠ æµè§ˆå™¨å‰ç¼€ï¼Œå®ç°æµè§ˆå™¨å…¼å®¹
  - Babel-loader: å®ç° js è½¬æ¢ï¼Œes6+ => es5ï¼ŒåŒæ—¶å¯ä»¥å®ç°åœ¨æ‰“åŒ… js æ—¶ï¼Œå®ç°ç¼“å­˜
  - thread-loaderï¼šå®ç°å¤šè¿›ç¨‹æ‰“åŒ…ï¼Œä¸€èˆ¬ç”¨äºå¤§å‹é¡¹ç›®å¼€å‘
- Plugin
  - Html-webpack-plugin: èƒ½å¤Ÿè‡ªåŠ¨å°†å…¶ä»–æ–‡ä»¶æ”¾åˆ° html æ–‡ä»¶ä¸­
  - Dotenv-webpack: é…ç½®ç¯å¢ƒå˜é‡
  - splitsChunksPlugin: å°†å…¬å…±ä¾èµ–çš„æ¨¡å—æå–åˆ°å·²æœ‰çš„å…¥å£ chunk ä¸­ï¼Œæˆ–è€…æå–åˆ°ä¸€ä¸ªæ–°ç”Ÿæˆçš„ chunkã€‚
  - `mini-css-extract-plugin`: ç”¨äºå°† CSS ä»ä¸»åº”ç”¨ç¨‹åºä¸­åˆ†ç¦»
  - webpack-bundle-analyzerï¼š æŸ¥çœ‹æ–‡ä»¶æ‰“åŒ…ç»“æœï¼Œæ–¹ä¾¿æˆ‘ä»¬åœ¨è¿›è¡Œé¡¹ç›®ä¼˜åŒ–æ—¶ï¼Œè¿›è¡Œé—®é¢˜è¯Šæ–­
  - optimize-css-assets-webpack-plugin ï¼š å‹ç¼© css

ä»€ä¹ˆæ˜¯ webpack: webpack æ˜¯ä¸€ä¸ªé™æ€æ¨¡å—åŒ–æ‰“åŒ…å·¥å…·ï¼Œé»˜è®¤åªæ”¯æŒ javascript å’Œ json æ ¼å¼çš„è¯­æ³•ï¼Œå¯¹äºå…¶ä»–ç±»å‹çš„æ–‡ä»¶ï¼Œéœ€è¦ä½¿ç”¨å¯¹åº”çš„ loader è¿›è¡Œè§£æï¼›webpack ä¼šå°†æ‰€æœ‰çš„èµ„æºéƒ½è§†ä¸ºä¸€ä¸ªä¸ªæ¨¡å—ï¼Œåˆ†ææ¨¡å—é—´çš„ä¾èµ–å…³ç³»ï¼Œæ„å»ºä¾èµ–å›¾ï¼Œæœ€ç»ˆç¼–è¯‘è¾“å‡º html,js.css ä»¥åŠå„ç§é™æ€æ–‡ä»¶(å›¾ç‰‡ï¼Œæ–‡å­—ç­‰),æé«˜å¼€å‘æ•ˆç‡ã€‚

webpack çš„ä¸»è¦ä½œç”¨ï¼š

- æ¨¡å—æ‰“åŒ…

å°†ä¸åŒçš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œå¹¶ä¿è¯ä»–ä»¬ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚åˆ©ç”¨æ‰“åŒ…æˆ‘ä»¬å¯ä»¥é¡¹ç›®å¼€å‘å·¥ç¨‹ä¸­ï¼Œæ ¹æ®ä¸šåŠ¡è‡ªç”±åˆ’åˆ†æ–‡ä»¶æ¨¡å—ï¼Œè®©é¡¹ç›®ç»“æ„æ›´åŠ æ¸…æ™°ã€‚

- ç¼–è¯‘å…¼å®¹

webpack é€šè¿‡ loader æœºåˆ¶ï¼Œä¸ä»…è®©é¡¹ç›®ä»£ç å®ç°äº† polyfill(å…¼å®¹æ€§å¤„ç†ï¼Œä¾‹å¦‚ï¼š postcss-loader æœ‰è‡ªåŠ¨æ·»åŠ å‰ç¼€çš„åŠŸèƒ½ï¼Œå¯ä»¥å®ç°å…¼å®¹æ€§å¤„ç†)ï¼Œè¿˜å®ç°äº†åƒ.lessï¼Œ .vueï¼Œ .jsx è¿™ç±»æµè§ˆå™¨ä¸èƒ½ç›´æ¥è¯†åˆ«æ–‡ä»¶çš„è§£æï¼›

- èƒ½åŠ›æ‰©å±•

webpack æä¾›äº† plugins æœºåˆ¶ï¼Œåœ¨å®ç°ä¸Šè¿°çš„æ‰“åŒ…ç¼–è¯‘åŠŸèƒ½åï¼Œwebpack è¿˜æä¾›äº†åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡ŒåŠŸèƒ½æ‰©å±•çš„å¤„ç†ï¼Œä¾‹å¦‚é€šè¿‡ optimize-css-assets-webpack-plugin å®ç° css ä»£ç çš„å‹ç¼©ï¼Œ ç­‰ï¼›

**å…³äº webpack çš„ä¸€ä¸ªå¤§è‡´è¿‡ç¨‹**

```JavaScript
/**
 * 1. æ ¹æ®é…ç½®æ–‡ä»¶å‚æ•°å’Œshellå‘½ä»¤ä¸­çš„å‚æ•°ï¼Œåˆå§‹åŒ–æ•´ä½“å‚æ•°åˆ—è¡¨
 * 2. ç”¨é…ç½®å‚æ•°åˆå§‹åŒ–compilerå¯¹è±¡
 * 3. æŒ‚è½½é…ç½®æ–‡ä»¶ä¸­çš„æ’ä»¶
 * 4. æ‰§è¡Œcompilerå¯¹è±¡ä¸­çš„runæ–¹æ³•ï¼Œå¼€å§‹ç¼–è¯‘
 * 5. æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„entryé…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£
 * 6. ä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œæ ¹æ®é…ç½®çš„loaderé€æ¬¡ç¼–è¯‘æ¨¡å—ä»¥åŠä¾èµ–çš„å…¶ä»–æ¨¡å—
 * 7. å®Œæˆç¼–è¯‘ä¹‹åï¼Œæ ¹æ®æ¯ä¸ªæ¨¡å—çš„ä¾èµ–å…³ç³»ï¼Œç»„è£…ä»£ç å—chunk
 * 8. æŠŠä»£ç å—chunkè½¬æ¢æˆä¸€ä¸ªä¸€ä¸ªæ–‡ä»¶åŠ å…¥åˆ°è¾“å‡ºåˆ—è¡¨
 * 9. ç¡®å®šè¾“å‡ºå†…å®¹ä¹‹åï¼Œæ ¹æ®é…ç½®çš„outputç­‰é…ç½®é¡¹ï¼Œå°†æ–‡ä»¶å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­
 */
```

## 2. æ¶æ„è®¾è®¡

**webpack çš„æ‰“åŒ…è¿‡ç¨‹å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ**

> 1. æ‰“åŒ…å‰çš„å‡†å¤‡å·¥ä½œ
> 2. æ‰“åŒ…è¿‡ç¨‹ä¸­ï¼Œä¹Ÿå°±æ˜¯ç¼–è¯‘é˜¶æ®µï¼Œæ­¤è¿‡ç¨‹è¿˜æœ‰ä¸€ä¸ªç›‘å¬æ–‡ä»¶å˜åŒ–çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯åœ¨æ–‡ä»¶å†…å®¹æ–¹æ³•å˜åŒ–çš„æ—¶å€™ï¼Œä¼šé‡æ–°è¿›è¡Œç¼–è¯‘
> 3. æ‰“åŒ…ç»“æŸï¼ˆåŒ…å«æ‰“åŒ…æˆåŠŸå’Œå¤±è´¥ï¼‰

åœ¨ **Webpack** æºç ä¸­ï¼Œ`compiler` å°±åƒæ˜¯ä¸€ä¸ªå¤§ç®¡å®¶ï¼Œå®ƒå°±ä»£è¡¨ä¸Šé¢è¯´çš„ä¸‰ä¸ªé˜¶æ®µï¼Œåœ¨å®ƒä¸Šé¢æŒ‚è½½ç€å„ç§ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œè€Œ `compilation` å°±åƒä¸“ç®¡ä¼™é£Ÿçš„å¨å¸ˆï¼Œä¸“é—¨è´Ÿè´£ç¼–è¯‘ç›¸å…³çš„å·¥ä½œï¼Œä¹Ÿå°±æ˜¯`æ‰“åŒ…è¿‡ç¨‹ä¸­`è¿™ä¸ªé˜¶æ®µã€‚ç”»ä¸ªå›¾å¸®åŠ©å¤§å®¶ç†è§£ï¼š

![img](../../public/f161b7e6-e85c-4e53-a65b-36bc89c9f516.png)

å¤§è‡´æ¶æ„å®šä¸‹åï¼Œé‚£ç°åœ¨åº”è¯¥å¦‚ä½•å®ç°è¿™å¥—äº‹ä»¶æµå‘¢ï¼Ÿ

è¿™æ—¶å€™å°±éœ€è¦å€ŸåŠ© [Tapable](https://link.juejin.cn/?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Ftapable) äº†ï¼å®ƒæ˜¯ä¸€ä¸ªç±»ä¼¼äº Node.js ä¸­çš„ [EventEmitter](https://link.juejin.cn/?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fevents) çš„åº“ï¼Œä½†**æ›´ä¸“æ³¨äºè‡ªå®šä¹‰äº‹ä»¶çš„è§¦å‘å’Œå¤„ç†**ã€‚é€šè¿‡ Tapable æˆ‘ä»¬å¯ä»¥æ³¨å†Œè‡ªå®šä¹‰äº‹ä»¶ï¼Œç„¶ååœ¨é€‚å½“çš„æ—¶æœºå»æ‰§è¡Œè‡ªå®šä¹‰äº‹ä»¶ã€‚

ç±»æ¯”åˆ° `Vue` å’Œ `React` æ¡†æ¶ä¸­çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œå®ƒä»¬å°±æ˜¯åˆ°äº†å›ºå®šçš„æ—¶é—´èŠ‚ç‚¹å°±æ‰§è¡Œå¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸï¼Œ`tapable` åšçš„äº‹æƒ…å°±å’Œè¿™ä¸ªå·®ä¸å¤šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒå…ˆæ³¨å†Œä¸€ç³»åˆ—çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶é—´ç‚¹æ‰§è¡Œã€‚

example ğŸŒ°ï¼š

```JavaScript
const { SyncHook } = require("tapable"); //è¿™æ˜¯ä¸€ä¸ªåŒæ­¥é’©å­
//ç¬¬ä¸€æ­¥ï¼šå®ä¾‹åŒ–é’©å­å‡½æ•°ï¼Œå¯ä»¥åœ¨è¿™é‡Œå®šä¹‰å½¢å‚
const syncHook = new SyncHook(["author", "age"]);
 //ç¬¬äºŒæ­¥ï¼šæ³¨å†Œäº‹ä»¶1
syncHook.tap("ç›‘å¬å™¨1", (name, age) => {   console.log("ç›‘å¬å™¨1:", name, age); });
  //ç¬¬äºŒæ­¥ï¼šæ³¨å†Œäº‹ä»¶2
syncHook.tap("ç›‘å¬å™¨2", (name) => {   console.log("ç›‘å¬å™¨2", name); });
  //ç¬¬ä¸‰æ­¥ï¼šæ³¨å†Œäº‹ä»¶3
syncHook.tap("ç›‘å¬å™¨3", (name) => {   console.log("ç›‘å¬å™¨3", name); });
  //ç¬¬ä¸‰æ­¥ï¼šè§¦å‘äº‹ä»¶ï¼Œè¿™é‡Œä¼ çš„æ˜¯å®å‚ï¼Œä¼šè¢«æ¯ä¸€ä¸ªæ³¨å†Œå‡½æ•°æ¥æ”¶åˆ°
syncHook.call("ä¸è¦ç§ƒå¤´å•Š", "99");
```

è¿è¡Œç»“æœï¼š

```JavaScript
ç›‘å¬å™¨1 ä¸è¦ç§ƒå¤´å•Š 99
ç›‘å¬å™¨2 ä¸è¦ç§ƒå¤´å•Š
ç›‘å¬å™¨3 ä¸è¦ç§ƒå¤´å•Š
```

åœ¨ Webpack ä¸­ï¼Œå°±æ˜¯é€šè¿‡ `tapable` åœ¨ `comiler` å’Œ `compilation` ä¸Šåƒè¿™æ ·æŒ‚è½½ç€ä¸€ç³»åˆ—`ç”Ÿå‘½å‘¨æœŸ Hook`ï¼Œå®ƒå°±åƒæ˜¯ä¸€åº§æ¡¥æ¢ï¼Œè´¯ç©¿ç€æ•´ä¸ªæ„å»ºè¿‡ç¨‹ï¼š

```JavaScript
class Compiler {
     constructor() {
         //å®ƒå†…éƒ¨æä¾›äº†å¾ˆå¤šé’©å­
         this.hooks = {
             run: new SyncHook(), //ä¼šåœ¨ç¼–è¯‘åˆšå¼€å§‹çš„æ—¶å€™è§¦å‘æ­¤é’©å­
             done: new SyncHook(), //ä¼šåœ¨ç¼–è¯‘ç»“æŸçš„æ—¶å€™è§¦å‘æ­¤é’©å­
         };
     }
 }
```

## 3. å…·ä½“å®ç°

å¤§è‡´è¿‡ç¨‹ï¼š

1. ä»é…ç½®æ–‡ä»¶ä¸­ä»¥åŠ shell å‘½ä»¤ä¸­è·å–å‚æ•°ï¼Œå¹¶è¿›è¡Œæ•´åˆï¼›ï¼ˆåœ¨ä¸‹é¢çš„å®ç°è¿‡ç¨‹ä¸­ï¼Œåªæ˜¯ä»é…ç½®æ–‡ä»¶ä¸­è·å–çš„å‚æ•°ï¼‰
2. æ ¹æ®ä¸Šé¢çš„å‚æ•°ä¿¡æ¯ï¼Œåˆå§‹åŒ–ä¸€ä¸ª compiler å¯¹è±¡ï¼›
3. æŒ‚è½½é…ç½®æ–‡ä»¶ä¸­çš„æ’ä»¶ï¼›
4. æ‰§è¡Œ compiler å¯¹è±¡ä¸Šçš„ run æ–¹æ³•ï¼Œå¼€å§‹æ‰§è¡Œç¼–è¯‘ï¼›
5. æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„ entry é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£ï¼›
6. ä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œè°ƒç”¨é…ç½®çš„ loader è§„åˆ™ï¼Œå¯¹å„ä¸ªæ¨¡å—è¿›è¡Œç¼–è¯‘ï¼›
7. æ‰¾å‡ºæ­¤æ¨¡å—æ‰€ä¾èµ–çš„æ¨¡å—ï¼Œå†å¯¹ä¾èµ–æ¨¡å—è¿›è¡Œç¼–è¯‘ï¼›
8. ç­‰æ‰€æœ‰æ¨¡å—éƒ½ç¼–è¯‘å®Œæˆä¹‹åï¼Œæ ¹æ®æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œç»„è£…ä»£ç å— chunkï¼›
9. æŠŠå„ä¸ªä»£ç å— chunk è½¬æ¢æˆä¸€ä¸ªä¸€ä¸ªæ–‡ä»¶åŠ å…¥åˆ°è¾“å‡ºåˆ—è¡¨ä¸­ï¼›
10. ç¡®å®šå¥½è¾“å‡ºå†…å®¹ä¹‹åï¼Œæ ¹æ®é…ç½®çš„è¾“å‡ºè·¯å¾„å’Œæ–‡ä»¶åï¼Œå°†æ–‡ä»¶å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ï¼›

### 3.1 æ­å»ºç»“æ„ï¼Œè¯»å–é…ç½®å‚æ•°

æ ¹æ® Webpack çš„ç”¨æ³•å¯ä»¥çœ‹å‡ºï¼Œwebpack æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªé…ç½®ä¿¡æ¯ä½œä¸ºå‚æ•°ï¼Œæ‰§è¡Œåè¿”å›ä¸€ä¸ª compiler å¯¹è±¡ï¼Œè°ƒç”¨ compiler å¯¹è±¡ä¸Šçš„ run æ–¹æ³•å°±ä¼šå¯åŠ¨ç¼–è¯‘ï¼Œrun æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥æŸ¥çœ‹ç¼–è¯‘è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¿¡æ¯æˆ–ç¼–è¯‘ä¿¡æ¯ã€‚

```JavaScript
// æ¨¡æ‹Ÿæ‰§è¡Œwebpackæ‰“åŒ…å‘½ä»¤æ—¶çš„æ‰§è¡Œæƒ…å†µ

const webpack = require("./webpack"); //æ‰‹å†™webpack
const webpackOptions = require("./webpack.config.js"); //è¿™é‡Œä¸€èˆ¬ä¼šæ”¾é…ç½®ä¿¡æ¯
const compiler = webpack(webpackOptions); // webpackå®åˆ™æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶é…ç½®å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªcompilerå¯¹è±¡

// æ‰§è¡Œrunæ–¹æ³•ï¼Œæ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå¯ä»¥æŸ¥çœ‹åˆ°ç¼–è¯‘è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¿¡æ¯å’Œç¼–è¯‘ä¿¡æ¯ï¼›
compiler.run((err, stats) => {
  console.log(err);
  console.log(
    stats.toJson({
      assets: true, //æ‰“å°æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æº
      chunks: true, //æ‰“å°æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„ä»£ç å—
      modules: true, //æ‰“å°æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ¨¡å—
    })
  );
});
```

**æ­å»º webpack å‡½æ•°**

```JavaScript
// ä¸€ä¸ªCompilerç±»
class Compiler {
  constructor() {}
  // å®ä¾‹ä¸Šçš„runæ–¹æ³•
  run(callback) {}
}

//ç¬¬ä¸€æ­¥ï¼šæ­å»ºç»“æ„ï¼Œè¯»å–é…ç½®å‚æ•°ï¼Œè¿™é‡Œæ¥æ”¶çš„æ˜¯webpack.config.jsä¸­çš„å‚æ•°
function webpack(webpackOptions) {
  const compiler = new Compiler()ï¼›// åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªcompilerå®ä¾‹
  return compiler;
}
```

è¿è¡Œæµç¨‹å›¾ï¼š

![img](../../public/5790fd29-76e2-41f9-bed8-3ad9415c01f1.png)

### 3.2 æ ¹æ®å‚æ•°åˆå§‹åŒ– compiler å¯¹è±¡

ä¸Šé¢æåˆ°è¿‡ï¼Œ`Compiler` å®ƒå°±æ˜¯æ•´ä¸ªæ‰“åŒ…è¿‡ç¨‹çš„å¤§ç®¡å®¶ï¼Œå®ƒé‡Œé¢æ”¾ç€å„ç§ä½ å¯èƒ½éœ€è¦çš„`ç¼–è¯‘ä¿¡æ¯`å’Œ`ç”Ÿå‘½å‘¨æœŸ Hook`ï¼Œè€Œä¸”æ˜¯å•ä¾‹æ¨¡å¼ã€‚(åœ¨å½“å‰çš„è¿è¡Œçš„çº¿ç¨‹ä¸­ï¼Œä¸€ä¸ªç±»å¯¹åº”çš„å®ä¾‹åªæœ‰ä¸€ä¸ªï¼Œå³ä¸ºå•ä¾‹æ¨¡å¼)

```JavaScript
const { SyncHook } = require('tapable'); // å¼•å…¥åŒæ­¥é’©å­

//Compilerå…¶å®æ˜¯ä¸€ä¸ªç±»ï¼Œå®ƒæ˜¯æ•´ä¸ªç¼–è¯‘è¿‡ç¨‹çš„å¤§ç®¡å®¶ï¼Œè€Œä¸”æ˜¯å•ä¾‹æ¨¡å¼
class Compiler {
+ constructor(webpackOptions) {
+   this.options = webpackOptions; //å­˜å‚¨é…ç½®ä¿¡æ¯
+   //å®ƒå†…éƒ¨æä¾›äº†å¾ˆå¤šé’©å­
+   this.hooks = {
+     run: new SyncHook(), //ä¼šåœ¨ç¼–è¯‘åˆšå¼€å§‹çš„æ—¶å€™è§¦å‘æ­¤runé’©å­
+     done: new SyncHook(), //ä¼šåœ¨ç¼–è¯‘ç»“æŸçš„æ—¶å€™è§¦å‘æ­¤doneé’©å­
+   };
+ }
}

//ç¬¬ä¸€æ­¥ï¼šæ­å»ºç»“æ„ï¼Œè¯»å–é…ç½®å‚æ•°ï¼Œè¿™é‡Œæ¥å—çš„æ˜¯webpack.config.jsä¸­çš„å‚æ•°
function webpack(webpackOptions) {
  //ç¬¬äºŒæ­¥ï¼šç”¨é…ç½®å‚æ•°å¯¹è±¡åˆå§‹åŒ– `Compiler` å¯¹è±¡
const compiler = new Compiler(webpackOptions)
  return compiler;
}
```

### 3.3 æŒ‚è½½é…ç½®æ–‡ä»¶ä¸­çš„æ’ä»¶

å…ˆå†™ä¸¤ä¸ªè‡ªå®šä¹‰æ’ä»¶é…ç½®åˆ° **webpack.config.js** ä¸­ï¼šä¸€ä¸ªåœ¨å¼€å§‹æ‰“åŒ…çš„æ—¶å€™æ‰§è¡Œï¼Œä¸€ä¸ªåœ¨æ‰“åŒ…å®Œæˆåæ‰§è¡Œã€‚

`Webpack Plugin å…¶å®å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­éœ€è¦æˆ‘ä»¬å®šåˆ¶ä¸€ä¸ª apply æ–¹æ³•ã€‚`ï¼ˆè¿™é‡Œçš„ apply æ–¹æ³•åªæ˜¯åå­—ä¸€æ ·ï¼Œå’Œ function.apply æ²¡æœ‰å…³ç³»ï¼‰å½“ Webpack å†…éƒ¨è¿›è¡Œæ’ä»¶æŒ‚è½½æ—¶ä¼šæ‰§è¡Œ `apply` å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ `apply` æ–¹æ³•ä¸­è®¢é˜…å„ç§ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œå½“åˆ°è¾¾å¯¹åº”çš„æ—¶é—´ç‚¹æ—¶å°±ä¼šæ‰§è¡Œã€‚

```JavaScript
// æŸ¥çœ‹å®åˆ™å°±æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°

// å®šä¹‰ä¸€ä¸ªæ¥å£
class PublicMethod {
    apply() {}
}

//è‡ªå®šä¹‰æ’ä»¶WebpackRunPlugin
class WebpackRunPlugin extends PublicMethod {
  apply(compiler) {
    compiler.hooks.run.tap("WebpackRunPlugin", () => {
      console.log("å¼€å§‹ç¼–è¯‘");
    });
  }
}

//è‡ªå®šä¹‰æ’ä»¶WebpackDonePlugin
class WebpackDonePlugin extends PublicMethod {
  apply(compiler) {
    compiler.hooks.done.tap("WebpackDonePlugin", () => {
      console.log("ç»“æŸç¼–è¯‘");
    });
  }
}
```

å®šä¹‰æ’ä»¶çš„æ—¶å€™ï¼Œå¿…é¡»è¦æœ‰ä¸€ä¸ªå…¬å…±çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€ä¸ªæ’ä»¶éƒ½å¿…é¡»è¦æœ‰ä¸€ä¸ªç›¸åŒçš„æ–¹æ³•åï¼Œä»¥æ­¤å®ç°åŠ è½½æ’ä»¶ï¼ŒåŠ è½½æ’ä»¶å®åˆ™å°±æ˜¯åœ¨æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼›ï¼ˆä½¿ç”¨ä¸€ä¸ªåŸº(çˆ¶)ç±»æ¥å®ç°è¿™ä¸ªï¼‰

```JavaScript
//ç¬¬ä¸€æ­¥ï¼šæ­å»ºç»“æ„ï¼Œè¯»å–é…ç½®å‚æ•°ï¼Œè¿™é‡Œæ¥å—çš„æ˜¯webpack.config.jsä¸­çš„å‚æ•°
function webpack(webpackOptions) {
  //ç¬¬äºŒæ­¥ï¼šç”¨é…ç½®å‚æ•°å¯¹è±¡åˆå§‹åŒ– `Compiler` å¯¹è±¡
  const compiler = new Compiler(webpackOptions);
  //ç¬¬ä¸‰æ­¥ï¼šæŒ‚è½½é…ç½®æ–‡ä»¶ä¸­çš„æ’ä»¶
+ const { plugins } = webpackOptions;
+ for (let plugin of plugins) {
+   plugin.apply(compiler);
+ }
  return compiler;
}
```

### 3.4 æ‰§è¡Œ`Compiler`å¯¹è±¡çš„`run`æ–¹æ³•å¼€å§‹æ‰§è¡Œç¼–è¯‘

åœ¨æ­£å¼å¼€å§‹ç¼–è¯‘å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè°ƒç”¨ compiler ä¸­çš„ run é’©å­(hook.run)ï¼Œè¡¨ç¤ºå¼€å§‹æ‰§è¡Œç¼–è¯‘ï¼Œåœ¨ç¼–è¯‘ç»“æŸåªæœ‰ï¼Œè°ƒç”¨ done é’©å­ï¼Œè¡¨ç¤ºç¼–è¯‘å®Œæˆï¼›

```JavaScript
//Compilerå…¶å®æ˜¯ä¸€ä¸ªç±»ï¼Œå®ƒæ˜¯æ•´ä¸ªç¼–è¯‘è¿‡ç¨‹çš„å¤§ç®¡å®¶ï¼Œè€Œä¸”æ˜¯å•ä¾‹æ¨¡å¼
class Compiler {
  constructor(webpackOptions) {
   //çœç•¥
  }

  // ç¼–è¯‘
+ compile(callback){
+  //
+ }

+ //ç¬¬å››æ­¥ï¼šæ‰§è¡Œ`Compiler`å¯¹è±¡çš„`run`æ–¹æ³•å¼€å§‹æ‰§è¡Œç¼–è¯‘
+ run(callback) {
+   this.hooks.run.call(); //åœ¨ç¼–è¯‘å‰è§¦å‘runé’©å­æ‰§è¡Œï¼Œè¡¨ç¤ºå¼€å§‹å¯åŠ¨ç¼–è¯‘äº†
+   const onCompiled = () => {
+     this.hooks.done.call(); //å½“ç¼–è¯‘æˆåŠŸåä¼šè§¦å‘doneè¿™ä¸ªé’©å­æ‰§è¡Œ
+   };
+   this.compile(onCompiled); //å¼€å§‹ç¼–è¯‘ï¼ŒæˆåŠŸä¹‹åè°ƒç”¨onCompiled
  }
}
```

ä¸Šé¢æ¶æ„è®¾è®¡ä¸­æåˆ°è¿‡ï¼Œç¼–è¯‘è¿™ä¸ªé˜¶æ®µéœ€è¦å•ç‹¬è§£è€¦å‡ºæ¥ï¼Œé€šè¿‡ `Compilation` æ¥å®Œæˆï¼Œå®šä¹‰`Compilation` å¤§è‡´ç»“æ„ï¼š

```JavaScript
class Compiler {
  //çœç•¥å…¶ä»–
  run(callback) {
    //çœç•¥
  }

  compile(callback) {
    //è™½ç„¶webpackåªæœ‰ä¸€ä¸ªCompilerï¼Œä½†æ˜¯æ¯æ¬¡ç¼–è¯‘éƒ½ä¼šäº§å‡ºä¸€ä¸ªæ–°çš„Compilationï¼Œ
    //è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†è€ƒè™‘åˆ°watchæ¨¡å¼ï¼Œå®ƒä¼šåœ¨å¯åŠ¨æ—¶å…ˆç¼–è¯‘ä¸€æ¬¡ï¼Œç„¶åç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ä¼šé‡æ–°å¼€å§‹ç¼–è¯‘
    //æ¯æ¬¡ç¼–è¯‘éƒ½ä¼šäº§å‡ºä¸€ä¸ªæ–°çš„Compilationï¼Œä»£è¡¨æ¯æ¬¡çš„ç¼–è¯‘ç»“æœ
+   let compilation = new Compilation(this.options);
+   compilation.build(callback); //æ‰§è¡Œcompilationçš„buildæ–¹æ³•è¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘æˆåŠŸä¹‹åæ‰§è¡Œå›è°ƒ
  }
}

+ class Compilation {
+   constructor(webpackOptions) {
+     this.options = webpackOptions;
+     this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
+     this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
+     this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
+     this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
+   }

+   build(callback) {
+    //è¿™é‡Œå¼€å§‹åšç¼–è¯‘å·¥ä½œï¼Œç¼–è¯‘æˆåŠŸæ‰§è¡Œcallback
+    callback()
+   }
+ }
```

ä»¥ä¸Šå°±æ˜¯æ‰“åŒ…å‰çš„å‡†å¤‡å·¥ä½œï¼›

### 3.5 æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„`entry`é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£

æ¥ä¸‹æ¥å°±æ­£å¼å¼€å§‹ç¼–è¯‘äº†ï¼Œé€»è¾‘å‡åœ¨ `Compilation` ä¸­ã€‚

åœ¨ç¼–è¯‘å‰æˆ‘ä»¬é¦–å…ˆéœ€è¦çŸ¥é“å…¥å£æ–‡ä»¶ï¼Œè€Œ [å…¥å£çš„é…ç½®æ–¹å¼](https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fconfiguration%2Fentry-context%2F%23entry) æœ‰å¤šç§ï¼Œå¯ä»¥é…ç½®æˆå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥é…ç½®æˆä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸€æ­¥éª¤å°±æ˜¯ä¸ºäº†ç»Ÿä¸€é…ç½®ä¿¡æ¯çš„æ ¼å¼ï¼Œç„¶åæ‰¾å‡ºæ‰€æœ‰çš„å…¥å£ï¼ˆè€ƒè™‘å¤šå…¥å£æ‰“åŒ…çš„åœºæ™¯ï¼‰ã€‚

```JavaScript
class Compilation {
  constructor(webpackOptions) {
    this.options = webpackOptions;
    this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
    this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
    this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
    this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
  }

  build(callback) {
    //ç¬¬äº”æ­¥ï¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„`entry`é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£
+   let entry = {};
+   if (typeof this.options.entry === "string") {
+     entry.main = this.options.entry; //å¦‚æœæ˜¯å•å…¥å£ï¼Œå°†entry:"xx"å˜æˆ{main:"xx"}ï¼Œè¿™é‡Œéœ€è¦åšå…¼å®¹
+   } else {
+     entry = this.options.entry; // å¯ä»¥é€šè¿‡Object.prototype.toString.call(thisArg) === '[object Object]' æ¥åˆ¤æ–­æ˜¯å¦ä¸ºä¸€ä¸ªå¯¹è±¡
+   }

    //ç¼–è¯‘æˆåŠŸæ‰§è¡Œcallback
    callback()
  }
}
```

### 3.6 ä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œè°ƒç”¨é…ç½®çš„`loader`è§„åˆ™ï¼Œå¯¹å„æ¨¡å—è¿›è¡Œç¼–è¯‘

Loader æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶èµ„æºæ–‡ä»¶æˆ–è€…ä¸Šä¸€ä¸ª Loader äº§ç”Ÿçš„ç»“æœä½œä¸ºå…¥å‚ï¼Œæœ€ç»ˆè¾“å‡ºè½¬æ¢åçš„ç»“æœã€‚

å†™ä¸¤ä¸ªè‡ªå®šä¹‰ Loader é…ç½®åˆ° **webpack.config.js** ä¸­ï¼š

```JavaScript
const loader1 = (source) => {
  return source + "//ç»™ä½ çš„ä»£ç åŠ ç‚¹æ³¨é‡Šï¼šloader1";
};

const loader2 = (source) => {
  return source + "//ç»™ä½ çš„ä»£ç åŠ ç‚¹æ³¨é‡Šï¼šloader2";
};

// æœ€ç»ˆä¼šåœ¨æºä»£ç å°¾éƒ¨æ·»åŠ ä¸¤æ¡æ³¨é‡Š
```

è¿™ä¸€æ­¥éª¤å°†ä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œç„¶åæŸ¥æ‰¾å‡ºå¯¹åº”çš„ Loader å¯¹æºä»£ç è¿›è¡Œç¿»è¯‘å’Œæ›¿æ¢ã€‚

ä¸»è¦æœ‰ä¸‰ä¸ªè¦ç‚¹ï¼š

- ï¼ˆ6.1ï¼‰æŠŠå…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ï¼ˆ`this.fileDependencies`ï¼‰ä¸­ï¼Œè®°å½•æ­¤æ¬¡ç¼–è¯‘ä¾èµ–çš„æ¨¡å—
- ï¼ˆ6.2ï¼‰å¾—åˆ°å…¥å£æ¨¡å—çš„çš„ `module` å¯¹è±¡ ï¼ˆé‡Œé¢æ”¾ç€è¯¥æ¨¡å—çš„è·¯å¾„ã€ä¾èµ–æ¨¡å—ã€æºä»£ç ç­‰ï¼‰
  - ï¼ˆ6.2.1ï¼‰è¯»å–æ¨¡å—å†…å®¹ï¼Œè·å–æºä»£ç 
  - ï¼ˆ6.2.2ï¼‰åˆ›å»ºæ¨¡å—å¯¹è±¡
  - ï¼ˆ6.2.3ï¼‰æ‰¾åˆ°å¯¹åº”çš„ `Loader` å¯¹æºä»£ç è¿›è¡Œç¿»è¯‘å’Œæ›¿æ¢
- ï¼ˆ6.3ï¼‰å°†ç”Ÿæˆçš„å…¥å£æ–‡ä»¶ `module` å¯¹è±¡ push è¿› `this.modules` ä¸­

  6.1 æŠŠå…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ä¸­ï¼Œè®°å½•æ­¤æ¬¡ç¼–è¯‘ä¾èµ–çš„æ¨¡å—

è¿™é‡Œå› ä¸ºè¦è·å–å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼Œè€ƒè™‘åˆ°æ“ä½œç³»ç»Ÿçš„å…¼å®¹æ€§é—®é¢˜ï¼Œéœ€è¦å°†è·¯å¾„çš„ \ éƒ½æ›¿æ¢æˆ / :

```JavaScript
//å°†\æ›¿æ¢æˆ/
function toUnixPath(filePath) {
  return filePath.replace(/\\/g, "/");
}

const baseDir = toUnixPath(process.cwd()); //è·å–å·¥ä½œç›®å½•ï¼Œåœ¨å“ªé‡Œæ‰§è¡Œå‘½ä»¤å°±è·å–å“ªé‡Œçš„ç›®å½•ï¼Œè¿™é‡Œè·å–çš„ä¹Ÿæ˜¯è·Ÿæ“ä½œç³»ç»Ÿæœ‰å…³ç³»ï¼Œè¦æ›¿æ¢æˆ/

class Compilation {
  constructor(webpackOptions) {
    this.options = webpackOptions;
    this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
    this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
    this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
    this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
  }

  build(callback) {
    //ç¬¬äº”æ­¥ï¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„`entry`é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£
    let entry = {};
    if (typeof this.options.entry === "string") {
      entry.main = this.options.entry; //å¦‚æœæ˜¯å•å…¥å£ï¼Œå°†entry:"xx"å˜æˆ{main:"xx"}ï¼Œè¿™é‡Œéœ€è¦åšå…¼å®¹
    } else {
      entry = this.options.entry;
    }
+   //ç¬¬å…­æ­¥ï¼šä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œè°ƒç”¨é…ç½®çš„ `loader` è§„åˆ™ï¼Œå¯¹å„æ¨¡å—è¿›è¡Œç¼–è¯‘
+   for (let entryName in entry) {
+     //entryName="main" entryNameå°±æ˜¯entryçš„å±æ€§åï¼Œä¹Ÿå°†ä¼šæˆä¸ºä»£ç å—çš„åç§°
+     let entryFilePath = path.posix.join(baseDir, entry[entryName]); //path.posixä¸ºäº†è§£å†³ä¸åŒæ“ä½œç³»ç»Ÿçš„è·¯å¾„åˆ†éš”ç¬¦,è¿™é‡Œæ‹¿åˆ°çš„å°±æ˜¯å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
+     //6.1 æŠŠå…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ï¼ˆ`this.fileDependencies`ï¼‰ä¸­ï¼Œè®°å½•æ­¤æ¬¡ç¼–è¯‘ä¾èµ–çš„æ¨¡å—
+     this.fileDependencies.push(entryFilePath);
+   }

    //ç¼–è¯‘æˆåŠŸæ‰§è¡Œcallback
    callback()
  }
}
```

6.2 è¯»å–æ¨¡å—å†…å®¹ï¼Œè·å–æºä»£ç 

```JavaScript
class Compilation {
  constructor(webpackOptions) {
    this.options = webpackOptions;
    this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
    this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
    this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
    this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
  }

+ //å½“ç¼–è¯‘æ¨¡å—çš„æ—¶å€™ï¼Œnameï¼šè¿™ä¸ªæ¨¡å—æ˜¯å±äºå“ªä¸ªä»£ç å—chunkçš„ï¼ŒmodulePathï¼šæ¨¡å—ç»å¯¹è·¯å¾„
+ buildModule(name, modulePath) {
+   //6.2.1 è¯»å–æ¨¡å—å†…å®¹ï¼Œè·å–æºä»£ç 
+   let sourceCode = fs.readFileSync(modulePath, "utf8");
+
+   return {};
+ }

  build(callback) {
    //ç¬¬äº”æ­¥ï¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„`entry`é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£
    //ä»£ç çœç•¥...
    //ç¬¬å…­æ­¥ï¼šä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œè°ƒç”¨é…ç½®çš„ `loader` è§„åˆ™ï¼Œå¯¹å„æ¨¡å—è¿›è¡Œç¼–è¯‘
    for (let entryName in entry) {
      //entryName="main" entryNameå°±æ˜¯entryçš„å±æ€§åï¼Œä¹Ÿå°†ä¼šæˆä¸ºä»£ç å—çš„åç§°
      let entryFilePath = path.posix.join(baseDir, entry[entryName]); //path.posixä¸ºäº†è§£å†³ä¸åŒæ“ä½œç³»ç»Ÿçš„è·¯å¾„åˆ†éš”ç¬¦,è¿™é‡Œæ‹¿åˆ°çš„å°±æ˜¯å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
      //6.1 æŠŠå…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ï¼ˆ`this.fileDependencies`ï¼‰ä¸­ï¼Œè®°å½•æ­¤æ¬¡ç¼–è¯‘ä¾èµ–çš„æ¨¡å—
      this.fileDependencies.push(entryFilePath);
      //6.2 å¾—åˆ°å…¥å£æ¨¡å—çš„çš„ `module` å¯¹è±¡ ï¼ˆé‡Œé¢æ”¾ç€è¯¥æ¨¡å—çš„è·¯å¾„ã€ä¾èµ–æ¨¡å—ã€æºä»£ç ç­‰ï¼‰
+     let entryModule = this.buildModule(entryName, entryFilePath);
    }

    //ç¼–è¯‘æˆåŠŸæ‰§è¡Œcallback
    callback()
  }
}
```

6.2.2 åˆ›å»ºæ¨¡å—å¯¹è±¡

```JavaScript
class Compilation {
  //çœç•¥å…¶ä»–

  //å½“ç¼–è¯‘æ¨¡å—çš„æ—¶å€™ï¼Œnameï¼šè¿™ä¸ªæ¨¡å—æ˜¯å±äºå“ªä¸ªä»£ç å—chunkçš„ï¼ŒmodulePathï¼šæ¨¡å—ç»å¯¹è·¯å¾„
  buildModule(name, modulePath) {
    //6.2.1 è¯»å–æ¨¡å—å†…å®¹ï¼Œè·å–æºä»£ç 
    let sourceCode = fs.readFileSync(modulePath, "utf8");
    //buildModuleæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªmodulesæ¨¡å—å¯¹è±¡ï¼Œæ¯ä¸ªæ¨¡å—éƒ½ä¼šæœ‰ä¸€ä¸ªid,idæ˜¯ç›¸å¯¹äºæ ¹ç›®å½•çš„ç›¸å¯¹è·¯å¾„
+   let moduleId = "./" + path.posix.relative(baseDir, modulePath); //æ¨¡å—id:ä»æ ¹ç›®å½•å‡ºå‘ï¼Œæ‰¾åˆ°ä¸è¯¥æ¨¡å—çš„ç›¸å¯¹è·¯å¾„ï¼ˆ./src/index.jsï¼‰
+   //6.2.2 åˆ›å»ºæ¨¡å—å¯¹è±¡
+   let module = {
+     id: moduleId,
+     names: [name], //namesè®¾è®¡æˆæ•°ç»„æ˜¯å› ä¸ºä»£è¡¨çš„æ˜¯æ­¤æ¨¡å—å±äºå“ªä¸ªä»£ç å—ï¼Œå¯èƒ½å±äºå¤šä¸ªä»£ç å—
+     dependencies: [], //å®ƒä¾èµ–çš„æ¨¡å—
+     _source: "", //è¯¥æ¨¡å—çš„ä»£ç ä¿¡æ¯
+   };
+   return module;
  }

  build(callback) {
    //çœç•¥
  }
}
```

6.2.3 æ‰¾åˆ°å¯¹åº”çš„ loader å¯¹æºä»£ç è¿›è¡Œç¿»è¯‘å’Œæ›¿æ¢

```JavaScript
class Compilation {
  //çœç•¥å…¶ä»–

  //å½“ç¼–è¯‘æ¨¡å—çš„æ—¶å€™ï¼Œnameï¼šè¿™ä¸ªæ¨¡å—æ˜¯å±äºå“ªä¸ªä»£ç å—chunkçš„ï¼ŒmodulePathï¼šæ¨¡å—ç»å¯¹è·¯å¾„
  buildModule(name, modulePath) {
    //6.2.1 è¯»å–æ¨¡å—å†…å®¹ï¼Œè·å–æºä»£ç 
    let sourceCode = fs.readFileSync(modulePath, "utf8");
    //buildModuleæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªmodulesæ¨¡å—å¯¹è±¡ï¼Œæ¯ä¸ªæ¨¡å—éƒ½ä¼šæœ‰ä¸€ä¸ªid,idæ˜¯ç›¸å¯¹äºæ ¹ç›®å½•çš„ç›¸å¯¹è·¯å¾„
    let moduleId = "./" + path.posix.relative(baseDir, modulePath); //æ¨¡å—id:ä»æ ¹ç›®å½•å‡ºå‘ï¼Œæ‰¾åˆ°ä¸è¯¥æ¨¡å—çš„ç›¸å¯¹è·¯å¾„ï¼ˆ./src/index.jsï¼‰
    //6.2.2 åˆ›å»ºæ¨¡å—å¯¹è±¡
    let module = {
      id: moduleId,
      names: [name], //namesè®¾è®¡æˆæ•°ç»„æ˜¯å› ä¸ºä»£è¡¨çš„æ˜¯æ­¤æ¨¡å—å±äºå“ªä¸ªä»£ç å—ï¼Œå¯èƒ½å±äºå¤šä¸ªä»£ç å—
      dependencies: [], //å®ƒä¾èµ–çš„æ¨¡å—
      _source: "", //è¯¥æ¨¡å—çš„ä»£ç ä¿¡æ¯
    };
    //6.2.3 æ‰¾åˆ°å¯¹åº”çš„ `Loader` å¯¹æºä»£ç è¿›è¡Œç¿»è¯‘å’Œæ›¿æ¢
+   let loaders = [];
+   let { rules = [] } = this.options.module;
+   rules.forEach((rule) => {
+     let { test } = rule;
+     //å¦‚æœæ¨¡å—çš„è·¯å¾„å’Œæ­£åˆ™åŒ¹é…ï¼Œå°±æŠŠæ­¤è§„åˆ™å¯¹åº”çš„loaderæ·»åŠ åˆ°loaderæ•°ç»„ä¸­
+     if (modulePath.match(test)) {
+       loaders.push(...rule.use);
+     }
+   });

+   //è‡ªå³å‘å·¦å¯¹æ¨¡å—è¿›è¡Œè½¬è¯‘
+   sourceCode = loaders.reduceRight((code, loader) => {
+     return loader(code);
+   }, sourceCode);

    return module;
  }

  build(callback) {
    //çœç•¥
  }
}
```

6.3 å°†ç”Ÿæˆçš„å…¥å£æ–‡ä»¶ module å¯¹è±¡ push è¿› this.modules ä¸­

```JavaScript
class Compilation {
  constructor(webpackOptions) {
    this.options = webpackOptions;
    this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
    this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
    this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
    this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
  }

  buildModule(name, modulePath) {
    //çœç•¥å…¶ä»–
  }

  build(callback) {
    //ç¬¬äº”æ­¥ï¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„`entry`é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£
    //çœç•¥å…¶ä»–
    //ç¬¬å…­æ­¥ï¼šä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œè°ƒç”¨é…ç½®çš„ `loader` è§„åˆ™ï¼Œå¯¹å„æ¨¡å—è¿›è¡Œç¼–è¯‘
    for (let entryName in entry) {
      //entryName="main" entryNameå°±æ˜¯entryçš„å±æ€§åï¼Œä¹Ÿå°†ä¼šæˆä¸ºä»£ç å—çš„åç§°
      let entryFilePath = path.posix.join(baseDir, entry[entryName]); //path.posixä¸ºäº†è§£å†³ä¸åŒæ“ä½œç³»ç»Ÿçš„è·¯å¾„åˆ†éš”ç¬¦,è¿™é‡Œæ‹¿åˆ°çš„å°±æ˜¯å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
      //6.1 æŠŠå…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ï¼ˆ`this.fileDependencies`ï¼‰ä¸­ï¼Œè®°å½•æ­¤æ¬¡ç¼–è¯‘ä¾èµ–çš„æ¨¡å—
      this.fileDependencies.push(entryFilePath);
      //6.2 å¾—åˆ°å…¥å£æ¨¡å—çš„çš„ `module` å¯¹è±¡ ï¼ˆé‡Œé¢æ”¾ç€è¯¥æ¨¡å—çš„è·¯å¾„ã€ä¾èµ–æ¨¡å—ã€æºä»£ç ç­‰ï¼‰
      let entryModule = this.buildModule(entryName, entryFilePath);
+     //6.3 å°†ç”Ÿæˆçš„å…¥å£æ–‡ä»¶ `module` å¯¹è±¡ push è¿› `this.modules` ä¸­
+     this.modules.push(entryModule);
    }
    //ç¼–è¯‘æˆåŠŸæ‰§è¡Œcallback
    callback()
  }
}
```

### 3.7 æ‰¾å‡ºæ­¤æ¨¡å—æ‰€ä¾èµ–çš„æ¨¡å—ï¼Œå†å¯¹ä¾èµ–æ¨¡å—è¿›è¡Œç¼–è¯‘

è¯¥æ­¥éª¤ç»è¿‡ç»†åŒ–å¯ä»¥å°†å…¶æ‹†åˆ†æˆåä¸ªå°æ­¥éª¤ï¼š

- ï¼ˆ7.1ï¼‰ï¼šå…ˆæŠŠæºä»£ç ç¼–è¯‘æˆ [AST](https://link.juejin.cn?target=https%3A%2F%2Fastexplorer.net%2F)
- ï¼ˆ7.2ï¼‰ï¼šåœ¨ `AST` ä¸­æŸ¥æ‰¾ `require` è¯­å¥ï¼Œæ‰¾å‡ºä¾èµ–çš„æ¨¡å—åç§°å’Œç»å¯¹è·¯å¾„
- ï¼ˆ7.3ï¼‰ï¼šå°†ä¾èµ–æ¨¡å—çš„ç»å¯¹è·¯å¾„ push åˆ° `this.fileDependencies` ä¸­
- ï¼ˆ7.4ï¼‰ï¼šç”Ÿæˆä¾èµ–æ¨¡å—çš„`æ¨¡å— id`
- ï¼ˆ7.5ï¼‰ï¼šä¿®æ”¹è¯­æ³•ç»“æ„ï¼ŒæŠŠä¾èµ–çš„æ¨¡å—æ”¹ä¸ºä¾èµ–`æ¨¡å— id`
- ï¼ˆ7.6ï¼‰ï¼šå°†ä¾èµ–æ¨¡å—çš„ä¿¡æ¯ push åˆ°è¯¥æ¨¡å—çš„ `dependencies` å±æ€§ä¸­
- ï¼ˆ7.7ï¼‰ï¼šç”Ÿæˆæ–°ä»£ç ï¼Œå¹¶æŠŠè½¬è¯‘åçš„æºä»£ç æ”¾åˆ° `module._source` å±æ€§ä¸Š
- ï¼ˆ7.8ï¼‰ï¼šå¯¹ä¾èµ–æ¨¡å—è¿›è¡Œç¼–è¯‘ï¼ˆå¯¹ `module å¯¹è±¡`ä¸­çš„ `dependencies` è¿›è¡Œé€’å½’æ‰§è¡Œ `buildModule` ï¼‰
- ï¼ˆ7.9ï¼‰ï¼šå¯¹ä¾èµ–æ¨¡å—ç¼–è¯‘å®Œæˆåå¾—åˆ°ä¾èµ–æ¨¡å—çš„ `module å¯¹è±¡`ï¼Œpush åˆ° `this.modules` ä¸­
- ï¼ˆ7.10ï¼‰ï¼šç­‰ä¾èµ–æ¨¡å—å…¨éƒ¨ç¼–è¯‘å®Œæˆåï¼Œè¿”å›å…¥å£æ¨¡å—çš„ `module` å¯¹è±¡

```JavaScript
+ const parser = require("@babel/parser");
+ let types = require("@babel/types"); //ç”¨æ¥ç”Ÿæˆæˆ–è€…åˆ¤æ–­èŠ‚ç‚¹çš„ASTè¯­æ³•æ ‘çš„èŠ‚ç‚¹
+ const traverse = require("@babel/traverse").default;
+ const generator = require("@babel/generator").default;

//è·å–æ–‡ä»¶è·¯å¾„
+ function tryExtensions(modulePath, extensions) {
+   if (fs.existsSync(modulePath)) {
+     return modulePath;
+   }
+   for (let i = 0; i < extensions?.length; i++) {
+     let filePath = modulePath + extensions[i];
+     if (fs.existsSync(filePath)) {
+       return filePath;
+     }
+   }
+   throw new Error(`æ— æ³•æ‰¾åˆ°${modulePath}`);
+ }

class Compilation {
  constructor(webpackOptions) {
    this.options = webpackOptions;
    this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
    this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
    this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
    this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
  }

  //å½“ç¼–è¯‘æ¨¡å—çš„æ—¶å€™ï¼Œnameï¼šè¿™ä¸ªæ¨¡å—æ˜¯å±äºå“ªä¸ªä»£ç å—chunkçš„ï¼ŒmodulePathï¼šæ¨¡å—ç»å¯¹è·¯å¾„
  buildModule(name, modulePath) {
    //çœç•¥å…¶ä»–
    //6.2.1 è¯»å–æ¨¡å—å†…å®¹ï¼Œè·å–æºä»£ç 
    //6.2.2 åˆ›å»ºæ¨¡å—å¯¹è±¡
    //6.2.3 æ‰¾åˆ°å¯¹åº”çš„ `Loader` å¯¹æºä»£ç è¿›è¡Œç¿»è¯‘å’Œæ›¿æ¢

    //è‡ªå³å‘å·¦å¯¹æ¨¡å—è¿›è¡Œè½¬è¯‘
    sourceCode = loaders.reduceRight((code, loader) => {
      return loader(code);
    }, sourceCode);

    //é€šè¿‡loaderç¿»è¯‘åçš„å†…å®¹ä¸€å®šå¾—æ˜¯jså†…å®¹ï¼Œå› ä¸ºæœ€åå¾—èµ°æˆ‘ä»¬babel-parseï¼Œåªæœ‰jsæ‰èƒ½æˆç¼–è¯‘AST
    //ç¬¬ä¸ƒæ­¥ï¼šæ‰¾å‡ºæ­¤æ¨¡å—æ‰€ä¾èµ–çš„æ¨¡å—ï¼Œå†å¯¹ä¾èµ–æ¨¡å—è¿›è¡Œç¼–è¯‘
+     //7.1ï¼šå…ˆæŠŠæºä»£ç ç¼–è¯‘æˆ [AST](https://astexplorer.net/)
+     let ast = parser.parse(sourceCode, { sourceType: "module" });
+     traverse(ast, {
+       CallExpression: (nodePath) => {
+         const { node } = nodePath;
+         //7.2ï¼šåœ¨ `AST` ä¸­æŸ¥æ‰¾ `require` è¯­å¥ï¼Œæ‰¾å‡ºä¾èµ–çš„æ¨¡å—åç§°å’Œç»å¯¹è·¯å¾„
+         if (node.callee.name === "require") {
+           let depModuleName = node.arguments[0].value; //è·å–ä¾èµ–çš„æ¨¡å—
+           let dirname = path.posix.dirname(modulePath); //è·å–å½“å‰æ­£åœ¨ç¼–è¯‘çš„æ¨¡æ‰€åœ¨çš„ç›®å½•
+           let depModulePath = path.posix.join(dirname, depModuleName); //è·å–ä¾èµ–æ¨¡å—çš„ç»å¯¹è·¯å¾„
+           let extensions = this.options.resolve?.extensions || [ ".js" ]; //è·å–é…ç½®ä¸­çš„extensions
+           depModulePath = tryExtensions(depModulePath, extensions); //å°è¯•æ·»åŠ åç¼€ï¼Œæ‰¾åˆ°ä¸€ä¸ªçœŸå®åœ¨ç¡¬ç›˜ä¸Šå­˜åœ¨çš„æ–‡ä»¶
+           //7.3ï¼šå°†ä¾èµ–æ¨¡å—çš„ç»å¯¹è·¯å¾„ push åˆ° `this.fileDependencies` ä¸­
+           this.fileDependencies.push(depModulePath);
+           //7.4ï¼šç”Ÿæˆä¾èµ–æ¨¡å—çš„`æ¨¡å— id`
+           let depModuleId = "./" + path.posix.relative(baseDir, depModulePath);
+           //7.5ï¼šä¿®æ”¹è¯­æ³•ç»“æ„ï¼ŒæŠŠä¾èµ–çš„æ¨¡å—æ”¹ä¸ºä¾èµ–`æ¨¡å— id` require("./name")=>require("./src/name.js")
+           node.arguments = [types.stringLiteral(depModuleId)];
+           //7.6ï¼šå°†ä¾èµ–æ¨¡å—çš„ä¿¡æ¯ push åˆ°è¯¥æ¨¡å—çš„ `dependencies` å±æ€§ä¸­
+           module.dependencies.push({ depModuleId, depModulePath });
+         }
+       },
+     });

+     //7.7ï¼šç”Ÿæˆæ–°ä»£ç ï¼Œå¹¶æŠŠè½¬è¯‘åçš„æºä»£ç æ”¾åˆ° `module._source` å±æ€§ä¸Š
+     let { code } = generator(ast);
+     module._source = code;
+     //7.8ï¼šå¯¹ä¾èµ–æ¨¡å—è¿›è¡Œç¼–è¯‘ï¼ˆå¯¹ `module å¯¹è±¡`ä¸­çš„ `dependencies` è¿›è¡Œé€’å½’æ‰§è¡Œ `buildModule` ï¼‰
+     module.dependencies.forEach(({ depModuleId, depModulePath }) => {
+       //è€ƒè™‘åˆ°å¤šå…¥å£æ‰“åŒ… ï¼šä¸€ä¸ªæ¨¡å—è¢«å¤šä¸ªå…¶ä»–æ¨¡å—å¼•ç”¨ï¼Œä¸éœ€è¦é‡å¤æ‰“åŒ…
+       let existModule = this.modules.find((item) => item.id === depModuleId);
+       //å¦‚æœmodulesé‡Œå·²ç»å­˜åœ¨è¿™ä¸ªå°†è¦ç¼–è¯‘çš„ä¾èµ–æ¨¡å—äº†ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦ç¼–è¯‘äº†ï¼Œç›´æ¥æŠŠæ­¤ä»£ç å—çš„åç§°æ·»åŠ åˆ°å¯¹åº”æ¨¡å—çš„nameså­—æ®µé‡Œå°±å¯ä»¥
+       if (existModule) {
+         //namesæŒ‡çš„æ˜¯å®ƒå±äºå“ªä¸ªä»£ç å—chunk
+         existModule.names.push(name);
+       } else {
+         //7.9ï¼šå¯¹ä¾èµ–æ¨¡å—ç¼–è¯‘å®Œæˆåå¾—åˆ°ä¾èµ–æ¨¡å—çš„ `module å¯¹è±¡`ï¼Œpush åˆ° `this.modules` ä¸­
+         let depModule = this.buildModule(name, depModulePath);
+         this.modules.push(depModule);
+       }
+     });
+     //7.10ï¼šç­‰ä¾èµ–æ¨¡å—å…¨éƒ¨ç¼–è¯‘å®Œæˆåï¼Œè¿”å›å…¥å£æ¨¡å—çš„ `module` å¯¹è±¡
+     return module;
   }
  //çœç•¥å…¶ä»–
}
```

### 3.8 ç­‰æ‰€æœ‰æ¨¡å—éƒ½ç¼–è¯‘å®Œæˆåï¼Œæ ¹æ®æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œç»„è£…ä»£ç å— `chunk`

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†å…¥å£æ¨¡å—å’Œå®ƒæ‰€ä¾èµ–æ¨¡å—çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¯ä»¥å»ç”Ÿæˆå¯¹åº”çš„ä»£ç å—äº†ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œæ¯ä¸ªå…¥å£æ–‡ä»¶ä¼šå¯¹åº”ä¸€ä¸ªä»£ç å—`chunk`ï¼Œæ¯ä¸ªä»£ç å—`chunk`é‡Œé¢ä¼šæ”¾ç€æœ¬å…¥å£æ¨¡å—å’Œå®ƒä¾èµ–çš„æ¨¡å—ï¼Œè¿™é‡Œæš‚æ—¶ä¸è€ƒè™‘ä»£ç åˆ†å‰²ã€‚

```JavaScript
class Compilation {
  constructor(webpackOptions) {
    this.options = webpackOptions;
    this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
    this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
    this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
    this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
  }

  buildModule(name, modulePath) {
   //çœç•¥å…¶ä»–
  }

  build(callback) {
    //ç¬¬äº”æ­¥ï¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„`entry`é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£
    //çœç•¥å…¶ä»–
    //ç¬¬å…­æ­¥ï¼šä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œè°ƒç”¨é…ç½®çš„ `loader` è§„åˆ™ï¼Œå¯¹å„æ¨¡å—è¿›è¡Œç¼–è¯‘
    for (let entryName in entry) {
      //entryName="main" entryNameå°±æ˜¯entryçš„å±æ€§åï¼Œä¹Ÿå°†ä¼šæˆä¸ºä»£ç å—çš„åç§°
      let entryFilePath = path.posix.join(baseDir, entry[entryName]); //path.posixä¸ºäº†è§£å†³ä¸åŒæ“ä½œç³»ç»Ÿçš„è·¯å¾„åˆ†éš”ç¬¦,è¿™é‡Œæ‹¿åˆ°çš„å°±æ˜¯å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
      //6.1 æŠŠå…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ï¼ˆ`this.fileDependencies`ï¼‰ä¸­ï¼Œè®°å½•æ­¤æ¬¡ç¼–è¯‘ä¾èµ–çš„æ¨¡å—
      this.fileDependencies.push(entryFilePath);
      //6.2 å¾—åˆ°å…¥å£æ¨¡å—çš„çš„ `module` å¯¹è±¡ ï¼ˆé‡Œé¢æ”¾ç€è¯¥æ¨¡å—çš„è·¯å¾„ã€ä¾èµ–æ¨¡å—ã€æºä»£ç ç­‰ï¼‰
      let entryModule = this.buildModule(entryName, entryFilePath);
      //6.3 å°†ç”Ÿæˆçš„å…¥å£æ–‡ä»¶ `module` å¯¹è±¡ push è¿› `this.modules` ä¸­
      this.modules.push(entryModule);
      //ç¬¬å…«æ­¥ï¼šç­‰æ‰€æœ‰æ¨¡å—éƒ½ç¼–è¯‘å®Œæˆåï¼Œæ ¹æ®æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œç»„è£…ä»£ç å— `chunk`ï¼ˆä¸€èˆ¬æ¥è¯´ï¼Œæ¯ä¸ªå…¥å£æ–‡ä»¶ä¼šå¯¹åº”ä¸€ä¸ªä»£ç å—`chunk`ï¼Œæ¯ä¸ªä»£ç å—`chunk`é‡Œé¢ä¼šæ”¾ç€æœ¬å…¥å£æ¨¡å—å’Œå®ƒä¾èµ–çš„æ¨¡å—ï¼‰
+     let chunk = {
+       name: entryName, //entryName="main" ä»£ç å—çš„åç§°
+       entryModule, //æ­¤ä»£ç å—å¯¹åº”çš„moduleçš„å¯¹è±¡,è¿™é‡Œå°±æ˜¯src/index.js çš„moduleå¯¹è±¡
+       modules: this.modules.filter((item) => item.names.includes(entryName)), //æ‰¾å‡ºå±äºè¯¥ä»£ç å—çš„æ¨¡å—
+     };
+     this.chunks.push(chunk);
    }
    //ç¼–è¯‘æˆåŠŸæ‰§è¡Œcallback
    callback()
  }
}
```

### 3.9 æŠŠå„ä¸ªä»£ç å— `chunk` è½¬æ¢æˆä¸€ä¸ªä¸€ä¸ªæ–‡ä»¶åŠ å…¥åˆ°è¾“å‡ºåˆ—è¡¨

è¿™ä¸€æ­¥éœ€è¦ç»“åˆé…ç½®æ–‡ä»¶ä¸­çš„`output.filename`å»ç”Ÿæˆè¾“å‡ºæ–‡ä»¶çš„æ–‡ä»¶åç§°ï¼ŒåŒæ—¶è¿˜éœ€è¦ç”Ÿæˆè¿è¡Œæ—¶ä»£ç ï¼š

```JavaScript
//ç”Ÿæˆè¿è¡Œæ—¶ä»£ç 
+ function getSource(chunk) {
+   return `
+    (() => {
+     var modules = {
+       ${chunk.modules.map(
+         (module) => `
+         "${module.id}": (module) => {
+           ${module._source}
+         }
+       `
+       )}
+     };
+     var cache = {};
+     function require(moduleId) {
+       var cachedModule = cache[moduleId];
+       if (cachedModule !== undefined) {
+         return cachedModule.exports;
+       }
+       var module = (cache[moduleId] = {
+         exports: {},
+       });
+       modules[moduleId](module, module.exports, require);
+       return module.exports;
+     }
+     var exports ={};
+     ${chunk.entryModule._source}
+   })();
+    `;
+ }

class Compilation {
  constructor(webpackOptions) {
    this.options = webpackOptions;
    this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
    this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
    this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
    this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
  }

  //å½“ç¼–è¯‘æ¨¡å—çš„æ—¶å€™ï¼Œnameï¼šè¿™ä¸ªæ¨¡å—æ˜¯å±äºå“ªä¸ªä»£ç å—chunkçš„ï¼ŒmodulePathï¼šæ¨¡å—ç»å¯¹è·¯å¾„
  buildModule(name, modulePath) {
    //çœç•¥
  }

  build(callback) {
    //ç¬¬äº”æ­¥ï¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„`entry`é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£
    //ç¬¬å…­æ­¥ï¼šä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œè°ƒç”¨é…ç½®çš„ `loader` è§„åˆ™ï¼Œå¯¹å„æ¨¡å—è¿›è¡Œç¼–è¯‘
    for (let entryName in entry) {
      //çœç•¥
      //6.1 æŠŠå…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ï¼ˆ`this.fileDependencies`ï¼‰ä¸­ï¼Œè®°å½•æ­¤æ¬¡ç¼–è¯‘ä¾èµ–çš„æ¨¡å—
      //6.2 å¾—åˆ°å…¥å£æ¨¡å—çš„çš„ `module` å¯¹è±¡ ï¼ˆé‡Œé¢æ”¾ç€è¯¥æ¨¡å—çš„è·¯å¾„ã€ä¾èµ–æ¨¡å—ã€æºä»£ç ç­‰ï¼‰
      //6.3 å°†ç”Ÿæˆçš„å…¥å£æ–‡ä»¶ `module` å¯¹è±¡ push è¿› `this.modules` ä¸­
      //ç¬¬å…«æ­¥ï¼šç­‰æ‰€æœ‰æ¨¡å—éƒ½ç¼–è¯‘å®Œæˆåï¼Œæ ¹æ®æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œç»„è£…ä»£ç å— `chunk`ï¼ˆä¸€èˆ¬æ¥è¯´ï¼Œæ¯ä¸ªå…¥å£æ–‡ä»¶ä¼šå¯¹åº”ä¸€ä¸ªä»£ç å—`chunk`ï¼Œæ¯ä¸ªä»£ç å—`chunk`é‡Œé¢ä¼šæ”¾ç€æœ¬å…¥å£æ¨¡å—å’Œå®ƒä¾èµ–çš„æ¨¡å—ï¼‰
    }

    //ç¬¬ä¹æ­¥ï¼šæŠŠå„ä¸ªä»£ç å— `chunk` è½¬æ¢æˆä¸€ä¸ªä¸€ä¸ªæ–‡ä»¶åŠ å…¥åˆ°è¾“å‡ºåˆ—è¡¨
+    this.chunks.forEach((chunk) => {
+      let filename = this.options.output.filename.replace("[name]", chunk.name);
+      this.assets[filename] = getSource(chunk);
+    });

+     callback(
+       null,
+       {
+         chunks: this.chunks,
+         modules: this.modules,
+         assets: this.assets,
+       },
+       this.fileDependencies
+     );
  }
}
```

åˆ°æ­¤ï¼Œå®Œæˆ compilation

### 3.10 ç¡®å®šå¥½è¾“å‡ºå†…å®¹ä¹‹åï¼Œæ ¹æ®é…ç½®çš„è¾“å‡ºè·¯å¾„å’Œæ–‡ä»¶åï¼Œå°†æ–‡ä»¶å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿ

```JavaScript
class Compiler {
  constructor(webpackOptions) {
    this.options = webpackOptions; //å­˜å‚¨é…ç½®ä¿¡æ¯
    //å®ƒå†…éƒ¨æä¾›äº†å¾ˆå¤šé’©å­
    this.hooks = {
      run: new SyncHook(), //ä¼šåœ¨ç¼–è¯‘åˆšå¼€å§‹çš„æ—¶å€™è§¦å‘æ­¤runé’©å­
      done: new SyncHook(), //ä¼šåœ¨ç¼–è¯‘ç»“æŸçš„æ—¶å€™è§¦å‘æ­¤doneé’©å­
    };
  }

  compile(callback) {
    //çœç•¥
  }

  //ç¬¬å››æ­¥ï¼šæ‰§è¡Œ`Compiler`å¯¹è±¡çš„`run`æ–¹æ³•å¼€å§‹æ‰§è¡Œç¼–è¯‘
  run(callback) {
    this.hooks.run.call(); //åœ¨ç¼–è¯‘å‰è§¦å‘runé’©å­æ‰§è¡Œï¼Œè¡¨ç¤ºå¼€å§‹å¯åŠ¨ç¼–è¯‘äº†
    const onCompiled = (err, stats, fileDependencies) => {
+     //ç¬¬åæ­¥ï¼šç¡®å®šå¥½è¾“å‡ºå†…å®¹ä¹‹åï¼Œæ ¹æ®é…ç½®çš„è¾“å‡ºè·¯å¾„å’Œæ–‡ä»¶åï¼Œå°†æ–‡ä»¶å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿï¼ˆè¿™é‡Œå°±æ˜¯ç¡¬ç›˜ï¼‰
+     for (let filename in stats.assets) {
+       let filePath = path.join(this.options.output.path, filename);
+       fs.writeFileSync(filePath, stats.assets[filename], "utf8");
+     }

+     callback(err, {
+       toJson: () => stats,
+     });

      this.hooks.done.call(); //å½“ç¼–è¯‘æˆåŠŸåä¼šè§¦å‘doneè¿™ä¸ªé’©å­æ‰§è¡Œ
    };
    this.compile(onCompiled); //å¼€å§‹ç¼–è¯‘ï¼ŒæˆåŠŸä¹‹åè°ƒç”¨onCompiled
  }
}
```

![img](../../public/f8230f87-fc99-4b6b-82bf-54a5e75c52a8.png)

### 3.11 å®ç° Watch æ¨¡å¼

çœ‹å®Œä¸Šé¢çš„å®ç°ï¼Œæœ‰äº›å°ä¼™ä¼´å¯èƒ½æœ‰ç–‘é—®äº†ï¼š`Compilation` ä¸­çš„ `this.fileDependencies`ï¼ˆæœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼‰æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Ÿä¸ºä»€ä¹ˆæ²¡æœ‰åœ°æ–¹ç”¨åˆ°è¯¥å±æ€§ï¼Ÿ

è¿™é‡Œå…¶å®æ˜¯ä¸ºäº†å®ç°[ Webpack çš„ watch æ¨¡å¼](https://link.juejin.cn?target=https%3A%2F%2Fwebpack.docschina.org%2Fguides%2Fdevelopment%2F%23using-watch-mode)ï¼šå½“æ–‡ä»¶å‘ç”Ÿå˜æ›´æ—¶å°†é‡æ–°ç¼–è¯‘ã€‚

æ€è·¯ï¼šå¯¹ `this.fileDependencies` é‡Œé¢çš„æ–‡ä»¶è¿›è¡Œç›‘å¬ï¼Œå½“æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé‡æ–°æ‰§è¡Œ `compile` å‡½æ•°

```JavaScript
class Compiler {
  constructor(webpackOptions) {
   //çœç•¥
  }

  compile(callback) {
    //è™½ç„¶webpackåªæœ‰ä¸€ä¸ªCompilerï¼Œä½†æ˜¯æ¯æ¬¡ç¼–è¯‘éƒ½ä¼šäº§å‡ºä¸€ä¸ªæ–°çš„Compilationï¼Œ
    //è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†è€ƒè™‘åˆ°watchæ¨¡å¼ï¼Œå®ƒä¼šåœ¨å¯åŠ¨æ—¶å…ˆç¼–è¯‘ä¸€æ¬¡ï¼Œç„¶åç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ä¼šé‡æ–°å¼€å§‹ç¼–è¯‘
    //æ¯æ¬¡ç¼–è¯‘éƒ½ä¼šäº§å‡ºä¸€ä¸ªæ–°çš„Compilationï¼Œä»£è¡¨æ¯æ¬¡çš„ç¼–è¯‘ç»“æœ
    let compilation = new Compilation(this.options);
    compilation.build(callback); //æ‰§è¡Œcompilationçš„buildæ–¹æ³•è¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘æˆåŠŸä¹‹åæ‰§è¡Œå›è°ƒ
  }

  //ç¬¬å››æ­¥ï¼šæ‰§è¡Œ`Compiler`å¯¹è±¡çš„`run`æ–¹æ³•å¼€å§‹æ‰§è¡Œç¼–è¯‘
  run(callback) {
    this.hooks.run.call(); //åœ¨ç¼–è¯‘å‰è§¦å‘runé’©å­æ‰§è¡Œï¼Œè¡¨ç¤ºå¼€å§‹å¯åŠ¨ç¼–è¯‘äº†
    const onCompiled = (err, stats, fileDependencies) => {
      //ç¬¬åæ­¥ï¼šç¡®å®šå¥½è¾“å‡ºå†…å®¹ä¹‹åï¼Œæ ¹æ®é…ç½®çš„è¾“å‡ºè·¯å¾„å’Œæ–‡ä»¶åï¼Œå°†æ–‡ä»¶å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿï¼ˆè¿™é‡Œå°±æ˜¯ç¡¬ç›˜ï¼‰
      for (let filename in stats.assets) {
        let filePath = path.join(this.options.output.path, filename);
        fs.writeFileSync(filePath, stats.assets[filename], "utf8");
      }

      callback(err, {
        toJson: () => stats,
      });

+     fileDependencies.forEach((fileDependencie) => {
+       fs.watch(fileDependencie, () => this.compile(onCompiled));
+     });

      this.hooks.done.call(); //å½“ç¼–è¯‘æˆåŠŸåä¼šè§¦å‘doneè¿™ä¸ªé’©å­æ‰§è¡Œ
    };
    this.compile(onCompiled); //å¼€å§‹ç¼–è¯‘ï¼ŒæˆåŠŸä¹‹åè°ƒç”¨onCompiled
  }
}
```

## 4. webpack çš„ä¸»è¦ç‰¹æ€§

### 1. ä»£ç åˆ†ç¦»

**ç›®å‰å¸¸ç”¨çš„ä»£ç åˆ†ç¦»æ–¹æ³•ï¼š**

- å…¥å£èµ·ç‚¹ï¼š ä½¿ç”¨ entry é…ç½®æ‰‹åŠ¨åœ°åˆ†ç¦»ä»£ç ï¼›
- é˜²æ­¢é‡å¤ï¼šä½¿ç”¨ SplitChunksPlugin å»é‡å’Œåˆ†ç¦» chunk;
- åŠ¨æ€å¯¼å…¥ï¼šé€šè¿‡æ¨¡å—ä¸­çš„å†…è”å‡½æ•°è°ƒç”¨æ¥åˆ†ç¦»ä»£ç ï¼›ï¼ˆè¿™é‡Œè¯´çš„å†…è”å‡½æ•°ï¼Œä¸æ˜¯ç±»ä¸­çš„å†…è”ï¼Œä¸»è¦æ˜¯æŒ‡ import ç­‰å‡½æ•°ï¼‰

> å½“æ¶‰åŠåˆ°åŠ¨æ€ä»£ç æ‹†åˆ†æ—¶ï¼Œwebpack æä¾›äº†ä¸¤ä¸ªç±»ä¼¼çš„æŠ€æœ¯ã€‚ç¬¬ä¸€ç§ï¼Œä¹Ÿæ˜¯æ¨èé€‰æ‹©çš„æ˜¯ä½¿ç”¨ç¬¦åˆ ECMAScript ææ¡ˆ çš„ import() è¯­æ³• æ¥å®ç°åŠ¨æ€å¯¼å…¥ã€‚ç¬¬äºŒç§ï¼Œåˆ™æ˜¯ webpack çš„é—ç•™åŠŸèƒ½ï¼Œä½¿ç”¨ webpack ç‰¹å®šçš„ require.ensureã€‚

### 2. é™æ€æ¨¡å—åŒ–æ‰“åŒ…

### 3. æ’ä»¶æœºåˆ¶
